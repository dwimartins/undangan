<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Animasi Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Input angka agar terlihat mencolok */
        .editable-input { border: 2px solid #e5e7eb; padding: 6px 8px; border-radius: 8px; width: 80px; text-align: center; font-weight: bold; color: #2563eb; transition: all 0.2s; }
        .editable-input:focus { outline: none; border-color: #2563eb; background-color: #eff6ff; }
        .editable-input:hover { border-color: #93c5fd; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <!-- Navbar -->
    <div class="bg-white border-b border-gray-200 sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <h1 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                <span class="bg-indigo-600 text-white px-2 py-1 rounded text-sm">ADMIN</span> Katalog Animasi
            </h1>
            <div class="text-sm font-medium" id="connection-status">
                <span class="inline-block w-2 h-2 bg-yellow-400 rounded-full mr-1 animate-pulse"></span> Menghubungkan...
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <!-- SIDEBAR: UPLOAD CSV (STRUKTUR) -->
        <div class="lg:col-span-1 space-y-6">
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 sticky top-24">
                <h2 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                    <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    1. Upload CSV
                </h2>
                <p class="text-xs text-gray-500 mb-4 leading-relaxed">
                    Gunakan file CSV untuk memperbarui struktur folder, judul, atau link. <br>
                    <span class="text-green-600 font-bold">✓ Aman:</span> Jumlah gambar tidak akan tertimpa/reset.
                </p>
                
                <label class="block w-full border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-indigo-50 hover:border-indigo-400 transition group">
                    <span class="text-sm text-gray-500 group-hover:text-indigo-600 font-medium block">Klik untuk Pilih CSV</span>
                    <span class="text-[10px] text-gray-400 mt-1 block">Format: id, category, title, folder_link</span>
                    <input type="file" id="csvFileInput" accept=".csv" class="hidden">
                </label>
                <div id="upload-info" class="mt-2 text-xs text-center text-gray-400 truncate bg-gray-100 py-1 rounded hidden"></div>
                
                <button onclick="processSmartSync()" id="btn-sync" class="w-full mt-4 bg-gray-800 text-white py-3 rounded-lg text-sm font-bold hover:bg-black transition disabled:opacity-50 disabled:cursor-not-allowed shadow-lg shadow-gray-200 flex justify-center items-center gap-2" disabled>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    Sync Database
                </button>
            </div>
        </div>

        <!-- MAIN AREA: DATA TABLE (JUMLAH GAMBAR) -->
        <div class="lg:col-span-3">
            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <!-- Toolbar -->
                <div class="p-5 border-b border-gray-100 flex flex-col sm:flex-row justify-between items-center gap-4 bg-gray-50/50">
                    <div>
                        <h2 class="font-bold text-gray-800 flex items-center gap-2">
                            <svg class="w-5 h-5 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                            2. Manajemen Stok Gambar
                        </h2>
                        <p class="text-xs text-gray-500 mt-1">Edit jumlah gambar di sini. Perubahan tersimpan otomatis.</p>
                    </div>
                    <div class="relative w-full sm:w-64">
                        <input type="text" id="searchInput" placeholder="Cari ID / Kategori..." class="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm focus:outline-none focus:border-indigo-500 bg-white">
                        <svg class="w-4 h-4 text-gray-400 absolute left-3 top-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    </div>
                </div>

                <!-- Table -->
                <div class="overflow-x-auto min-h-[400px] max-h-[70vh]">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0 z-10 shadow-sm">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Info Tier</th>
                                <th class="px-6 py-3 text-center text-xs font-bold text-gray-500 uppercase tracking-wider bg-blue-50/50 border-x border-blue-100">Jumlah Gambar</th>
                                <th class="px-6 py-3 text-left text-xs font-bold text-gray-500 uppercase tracking-wider">Link Folder</th>
                                <th class="px-6 py-3 text-right text-xs font-bold text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                            <tr><td colspan="4" class="text-center py-20 text-gray-400 flex flex-col items-center"><div class="w-8 h-8 border-4 border-indigo-500 border-t-transparent rounded-full animate-spin mb-2"></div>Memuat data...</td></tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Footer Info -->
                <div class="bg-gray-50 p-3 text-xs text-gray-500 text-center border-t border-gray-100 flex justify-between px-6">
                    <span>Total Item: <strong id="total-items">0</strong></span>
                    <span class="text-indigo-600 cursor-pointer hover:underline" onclick="loadFromFirebase()">Refresh Data</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-xl transform translate-y-20 opacity-0 transition-all duration-300 z-50 text-sm flex items-center gap-3 border border-gray-700">
        <div id="toast-icon"></div>
        <span id="toast-msg">Notifikasi</span>
    </div>

    <script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyDq6LjlUFRDm5CqGSqVLiJ9gItIyw71bAU",
            authDomain: "db-katalog.firebaseapp.com",
            projectId: "db-katalog",
            storageBucket: "db-katalog.firebasestorage.app",
            messagingSenderId: "597535674259",
            appId: "1:597535674259:web:0577885c617f623bb82266"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentData = [];
        let csvData = [];

        // --- 2. INIT & LOAD ---
        window.onload = function() {
            loadFromFirebase();
        };

        function showToast(msg, type='success') {
            const toast = document.getElementById('toast');
            const msgEl = document.getElementById('toast-msg');
            const iconEl = document.getElementById('toast-icon');
            
            msgEl.innerText = msg;
            
            if(type === 'success') {
                toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 text-sm flex items-center gap-3 bg-gray-900 text-white border border-green-500/30`;
                iconEl.innerHTML = `<svg class="w-5 h-5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
            } else {
                toast.className = `fixed bottom-5 right-5 px-6 py-3 rounded-lg shadow-xl transform transition-all duration-300 z-50 text-sm flex items-center gap-3 bg-red-900 text-white border border-red-500/30`;
                iconEl.innerHTML = `<svg class="w-5 h-5 text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;
            }

            toast.style.transform = 'translateY(0)';
            toast.style.opacity = '1';
            
            setTimeout(() => {
                toast.style.transform = 'translateY(20px)';
                toast.style.opacity = '0';
            }, 3000);
        }

        async function loadFromFirebase() {
            const tbody = document.getElementById('table-body');
            const status = document.getElementById('connection-status');
            
            try {
                // Fetch collection 'animasi_catalog'
                const snapshot = await db.collection('animasi_catalog').get();
                currentData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // Sort: Kategori A-Z, lalu Judul A-Z
                currentData.sort((a,b) => a.category.localeCompare(b.category) || a.title.localeCompare(b.title));
                
                renderTable(currentData);
                status.innerHTML = `<span class="inline-block w-2 h-2 bg-green-500 rounded-full mr-1"></span> Terhubung`;
                status.className = 'text-sm font-medium text-green-600';
                document.getElementById('total-items').innerText = currentData.length;
            } catch (error) {
                console.error(error);
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-red-500 font-bold bg-red-50">Gagal memuat data. Periksa koneksi internet.<br><span class="text-xs font-normal text-gray-500">${error.message}</span></td></tr>`;
                status.innerHTML = `<span class="inline-block w-2 h-2 bg-red-500 rounded-full mr-1"></span> Disconnect`;
                status.className = 'text-sm font-medium text-red-600';
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            tbody.innerHTML = '';
            
            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="text-center py-10 text-gray-400">Belum ada data. Silakan upload CSV Struktur.</td></tr>`;
                return;
            }

            data.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50 transition border-b border-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4 align-top">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="bg-gray-100 text-gray-500 text-[10px] font-mono px-1.5 py-0.5 rounded border border-gray-200" title="ID Unik">${item.id}</span>
                            <span class="text-[10px] font-bold text-indigo-600 uppercase tracking-wide bg-indigo-50 px-2 py-0.5 rounded-full">${item.category}</span>
                        </div>
                        <div class="text-sm font-bold text-gray-800">${item.title}</div>
                    </td>
                    <td class="px-6 py-4 text-center align-top bg-blue-50/20 border-x border-blue-50">
                        <input type="number" 
                               value="${item.total || 0}" 
                               class="editable-input"
                               onchange="updateCount('${item.id}', this.value)"
                               onkeypress="if(event.key === 'Enter') this.blur()"
                               min="0">
                        <div class="text-[10px] text-gray-400 mt-1">Gambar</div>
                    </td>
                    <td class="px-6 py-4 align-top">
                        <div class="text-xs text-gray-500 truncate max-w-[250px] font-mono bg-gray-50 p-1.5 rounded border border-gray-200 select-all" title="${item.folder_link}">${item.folder_link}</div>
                        <a href="${item.folder_link}" target="_blank" class="text-[10px] text-blue-500 hover:underline mt-1 inline-block">Buka Link &nearr;</a>
                    </td>
                    <td class="px-6 py-4 text-right align-top">
                        <button onclick="deleteItem('${item.id}')" class="text-red-400 hover:text-red-600 p-2 rounded-lg hover:bg-red-50 transition border border-transparent hover:border-red-100 group" title="Hapus Data">
                            <svg class="w-5 h-5 group-hover:scale-110 transition-transform" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // --- 3. LOGIKA LIVE EDIT (BUKU B) ---
        async function updateCount(docId, newValue) {
            try {
                const val = parseInt(newValue);
                if (isNaN(val) || val < 0) return;

                // Hanya update field 'total' di database
                await db.collection('animasi_catalog').doc(docId).update({
                    total: val
                });
                
                // Update local data biar search tetap akurat tanpa refresh
                const idx = currentData.findIndex(d => d.id === docId);
                if(idx > -1) currentData[idx].total = val;
                
                showToast(`Stok ${docId} disimpan: ${val} gambar`);
            } catch (error) {
                console.error(error);
                showToast("Gagal menyimpan perubahan", "error");
            }
        }

        async function deleteItem(docId) {
            if(confirm(`PERINGATAN!\n\nAnda akan menghapus data ID: ${docId}.\nData jumlah gambar akan hilang permanen.\n\nLanjutkan?`)) {
                try {
                    await db.collection('animasi_catalog').doc(docId).delete();
                    currentData = currentData.filter(d => d.id !== docId);
                    renderTable(currentData);
                    document.getElementById('total-items').innerText = currentData.length;
                    showToast("Data berhasil dihapus");
                } catch (e) {
                    showToast("Gagal menghapus data", "error");
                }
            }
        }

        // --- 4. SMART SYNC (BUKU A) ---
        document.getElementById('csvFileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const infoDiv = document.getElementById('upload-info');
            infoDiv.innerText = `File terpilih: ${file.name}`;
            infoDiv.classList.remove('hidden');
            
            const btn = document.getElementById('btn-sync');
            btn.disabled = false;
            btn.classList.remove('bg-gray-800', 'hover:bg-black');
            btn.classList.add('bg-indigo-600', 'hover:bg-indigo-700', 'animate-pulse');

            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
        });

        function parseCSV(text) {
            const lines = text.split('\n');
            csvData = [];
            
            // Deteksi Header: Cek baris pertama mengandung "id" atau "category"
            // Kita skip baris pertama jika itu header
            let start = 0;
            if (lines[0] && (lines[0].toLowerCase().includes('id') || lines[0].toLowerCase().includes('category'))) {
                start = 1;
            }

            for(let i=start; i<lines.length; i++) {
                const line = lines[i].trim();
                if(!line) continue;
                
                // Split koma (Sederhana)
                const cols = line.split(',');
                
                // Pastikan ada 4 kolom: id, category, title, link
                if(cols.length >= 4) {
                    csvData.push({
                        id: cols[0].trim(),
                        category: cols[1].trim(),
                        title: cols[2].trim(),
                        folder_link: cols[3].trim()
                    });
                }
            }
        }

        async function processSmartSync() {
            const btn = document.getElementById('btn-sync');
            btn.disabled = true;
            btn.classList.remove('animate-pulse');
            btn.innerHTML = `<div class="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div> Memproses...`;
            
            let added = 0;
            let updated = 0;

            try {
                // Batch write untuk performa & atomicity
                const batchSize = 400;
                let batch = db.batch();
                let opCount = 0;

                // Map data existing untuk lookup cepat
                const existingMap = {};
                currentData.forEach(d => existingMap[d.id] = d);

                for (const item of csvData) {
                    // Validasi ID sederhana (minimal 2 huruf)
                    if (!item.id || item.id.length < 2) continue;

                    const docRef = db.collection('animasi_catalog').doc(item.id);
                    
                    if (existingMap[item.id]) {
                        // KASUS 1: DATA SUDAH ADA (Update Struktur Saja)
                        // KITA TIDAK MENYENTUH FIELD 'total' -> AMAN!
                        batch.update(docRef, {
                            category: item.category,
                            title: item.title,
                            folder_link: item.folder_link
                        });
                        updated++;
                    } else {
                        // KASUS 2: DATA BARU (Buat Dokumen Baru)
                        batch.set(docRef, {
                            id: item.id, 
                            category: item.category,
                            title: item.title,
                            folder_link: item.folder_link,
                            total: 0 // Default 0, nanti diisi manual di tabel
                        });
                        added++;
                    }
                    
                    opCount++;
                    if (opCount % batchSize === 0) {
                        await batch.commit();
                        batch = db.batch();
                    }
                }
                
                if (opCount > 0) await batch.commit();
                
                await loadFromFirebase(); // Refresh tabel
                alert(`✅ Sinkronisasi Berhasil!\n\n• Data Baru Ditambahkan: ${added}\n• Data Lama Diupdate: ${updated}\n\nCatatan: Jumlah gambar pada data lama TIDAK BERUBAH.`);
                
            } catch (error) {
                console.error(error);
                alert("❌ Terjadi kesalahan saat sync: " + error.message);
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg> Sync Database`;
                btn.classList.add('bg-gray-800');
                btn.classList.remove('bg-indigo-600');
                document.getElementById('csvFileInput').value = '';
                document.getElementById('upload-info').classList.add('hidden');
            }
        }

        // --- 5. SEARCH FILTER ---
        document.getElementById('searchInput').addEventListener('keyup', function(e) {
            const term = e.target.value.toLowerCase();
            const filtered = currentData.filter(item => 
                item.title.toLowerCase().includes(term) || 
                item.category.toLowerCase().includes(term) ||
                item.id.toLowerCase().includes(term)
            );
            renderTable(filtered);
        });

    </script>
</body>
</html>
